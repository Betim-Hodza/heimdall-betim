# Heimdall Ada ALI File Extractor

This document describes the Ada ALI file extractor functionality that has been added to Heimdall to enhance SBOM generation for Ada applications.

## Overview

The Ada extractor parses GNAT ALI (Ada Library Information) files to extract comprehensive metadata about Ada applications, including:

- **Package Dependencies**: Complete dependency graph between Ada packages
- **Function Signatures**: Public and private functions/procedures with parameter types
- **Build Configuration**: GNAT compiler version and runtime flags
- **Source File Information**: Mapping between ALI files and source files
- **Variable and Type Information**: Data structures and variables used

## What are ALI Files?

ALI files are generated by the GNAT Ada compiler and contain detailed information about:

1. **Dependencies**: Which packages depend on which other packages
2. **Functions**: Function names, signatures, and visibility
3. **Variables**: Variable names and types
4. **Build Info**: Compiler version, runtime flags, and build configuration
5. **Source Mapping**: Links between ALI files and source files (.ads/.adb)

## Files Added

### Core Implementation
- `src/common/AdaExtractor.hpp` - Header file with Ada extractor interface
- `src/common/AdaExtractor.cpp` - Implementation of Ada ALI file parser
- Updated `src/common/MetadataExtractor.hpp` - Integration with main extractor
- Updated `src/common/MetadataExtractor.cpp` - Ada extraction methods

### Data Structures

```cpp
struct AdaPackageInfo {
    std::string name;                    // Package name
    std::string sourceFile;              // Source file (.ads/.adb)
    std::string aliFile;                 // ALI file path
    std::string checksum;                // File checksum
    std::string timestamp;               // File timestamp
    std::vector<std::string> functions;  // List of functions/procedures
    std::vector<std::string> variables;  // List of variables
    std::vector<std::string> types;      // List of types
    std::vector<std::string> dependencies; // Package dependencies
    bool isSpecification = false;        // Whether this is a spec (.ads) or body (.adb)
    bool isRuntime = false;              // Whether this is a runtime package
};

struct AdaFunctionInfo {
    std::string name;                    // Function name
    std::string package;                 // Package containing the function
    std::string signature;               // Function signature with parameters
    std::string returnType;              // Return type (if any)
    std::vector<std::string> parameters; // Parameter types
    bool isPublic = false;               // Whether the function is public
    bool isProcedure = false;            // Whether this is a procedure (no return)
};

struct AdaBuildInfo {
    std::string compilerVersion;         // GNAT compiler version
    std::vector<std::string> runtimeFlags; // Runtime configuration flags
    std::vector<std::string> compilationFlags; // Compilation flags
    std::string targetArchitecture;      // Target architecture
    std::string buildTimestamp;          // Build timestamp
};
```

## Usage

### Basic Usage

```cpp
#include "AdaExtractor.hpp"

// Create Ada extractor
heimdall::AdaExtractor extractor;
extractor.setVerbose(true);
extractor.setExtractRuntimePackages(false); // Skip runtime packages by default

// Find ALI files
std::vector<std::string> aliFiles;
extractor.findAliFiles(".", aliFiles);

// Extract metadata
heimdall::ComponentInfo component("my-ada-app", "path/to/binary");
extractor.extractAdaMetadata(component, aliFiles);
```

### Integration with Heimdall

The Ada extractor is automatically integrated into Heimdall's main metadata extraction pipeline:

```cpp
heimdall::MetadataExtractor extractor;

// Check if ALI files are present
std::vector<std::string> aliFiles;
if (extractor.findAdaAliFiles(directory, aliFiles)) {
    // Extract Ada-specific metadata
    extractor.extractAdaMetadata(component, aliFiles);
}
```

## ALI File Format

ALI files use a line-based format with different record types:

### Version Line
```
V "GNAT Lib v11"
```
- Contains compiler version information

### Dependency Lines
```
W ada%s                 ada.ads                 ada.ali
W data_reader%s         data_reader.adb         data_reader.ali
```
- Format: `W package_name%spec_or_body source_file.ads/adb source_file.ali`
- Indicates package dependencies

### Function Lines
```
X 11 main.adb 6U11*Main 6b11 15l5 15t9
```
- Format: `X line_number file_name function_info location_info`
- Contains function names and signatures

### Variable Lines
```
X 11 main.adb 7a4 Data{string} 14r39
```
- Format: `X line_number file_name variable_info location_info`
- Contains variable names and types

### Runtime Flags
```
RV NO_SECONDARY_STACK
RV NO_DYNAMIC_SIZED_OBJECTS
```
- Indicates runtime configuration options

## SBOM Enhancement

The Ada extractor enhances SBOM generation by providing:

### Enhanced Component Tree
- Maps Ada package hierarchy to SBOM components
- Tracks library dependencies (user vs runtime)
- Version tracking based on file timestamps

### Function-Level Granularity
- Includes individual Ada procedures/functions as sub-components
- Tracks function dependencies and call graphs
- Parameter type information for API documentation

### Build Configuration
- GNAT compiler version and options
- Runtime feature flags
- Compilation timestamp and environment

### Dependency Resolution
- Automatic detection of Ada runtime dependencies
- Version compatibility checking
- Circular dependency detection

## Example Output

### Extracted Metadata
```
Component Name: heimdall-ada-demo
Package Manager: GNAT
Version: GNAT Lib v11

Dependencies (4):
  - data_reader
  - string_utils
  - math_lib
  - main

Functions (3):
  - read_data_file(string)
  - factorial(integer)
  - to_upper(string)

Source Files (4):
  - src/data_reader.adb
  - src/string_utils.adb
  - src/math_lib.adb
  - src/main.adb
```

### Generated SBOM
The Ada extractor enhances SBOM generation with:

1. **Package Manager Detection**: Automatically identifies GNAT as the package manager
2. **Version Information**: Extracts GNAT compiler version
3. **Dependency Graph**: Maps Ada package dependencies
4. **Function Signatures**: Includes function names and parameter types
5. **Source File Mapping**: Links binaries to source files

## Testing

### Test Program
A test program is included to demonstrate the Ada extractor:

```bash
cd examples/heimdall-ada-demo
g++ -std=c++17 -I../../src -I../../src/common -L../../build/lib -lheimdall-core -o test_ada_extractor test_ada_extractor.cpp
LD_LIBRARY_PATH=../../build/lib ./test_ada_extractor
```

### SBOM Generation
Generate SBOMs for Ada applications:

```bash
# SPDX 2.3 format
./heimdall-sbom lib/heimdall-gold.so bin/main_static --format spdx-2.3 --output ada_demo.spdx.json

# CycloneDX 1.6 format
./heimdall-sbom lib/heimdall-gold.so bin/main_static --format cyclonedx-1.6 --output ada_demo.cyclonedx.json
```

## Benefits

1. **First-of-its-kind**: Heimdall is the first SBOM tool to provide Ada-specific metadata extraction
2. **Rich Information**: Much more detailed than binary analysis alone
3. **Dependency Resolution**: Automatic detection of Ada package dependencies
4. **Build Configuration**: Extracts compiler and runtime information
5. **Function Granularity**: Provides function-level detail for API documentation

## Future Enhancements

Potential future improvements:

1. **Circular Dependency Detection**: Identify and report circular dependencies
2. **Version Compatibility**: Check Ada runtime version compatibility
3. **Security Analysis**: Identify security-relevant metadata
4. **Performance Optimization**: Parallel processing of large ALI file sets
5. **Extended Metadata**: Extract more detailed type information and constraints

## Conclusion

The Ada ALI file extractor significantly enhances Heimdall's SBOM generation capabilities for Ada applications, providing much richer metadata than traditional binary analysis tools. This makes Heimdall the first comprehensive SBOM tool with native Ada support. 