name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      cpp_standard:
        description: 'C++ Standard to test'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - 11
        - 23
      compiler:
        description: 'Compiler to use'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - gcc
        - clang

env:
  # Test configuration
  CTEST_OUTPUT_ON_FAILURE: 1
  CTEST_PARALLEL_LEVEL: 2

jobs:
  # C++11 Build and Test
  cpp11-gcc:
    name: C++11 GCC Build & Test
    runs-on: ubuntu-22.04
    if: github.event.inputs.cpp_standard == 'all' || github.event.inputs.cpp_standard == '11' || github.event.inputs.compiler == 'all' || github.event.inputs.compiler == 'gcc'
    env:
      BUILD_DIR: build-cpp11
    strategy:
      matrix:
        cpp_standard: [11]
        compiler: [gcc]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            binutils-gold \
            libssl-dev \
            libelf-dev \
            pkg-config \
            libboost-filesystem-dev \
            libboost-system-dev

      - name: Install LLVM 18
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y llvm-18-dev lld-18

      - name: Set up LLVM Environment
        run: |
          echo "LLVM_CONFIG=/usr/bin/llvm-config-18" >> $GITHUB_ENV
          echo "LLVM_VERSION=18" >> $GITHUB_ENV
          echo "CC=gcc" >> $GITHUB_ENV
          echo "CXX=g++" >> $GITHUB_ENV

      - name: Build C++11 with GCC
        run: |
          ./scripts/build.sh --standard 11 --compiler gcc --clean --tests

      - name: Run Unit Tests
        run: |
          cd $BUILD_DIR
          ctest --output-on-failure --verbose

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-cpp11-gcc
          path: $BUILD_DIR/Testing/
          retention-days: 7

  cpp11-clang:
    name: C++11 Clang Build & Test
    runs-on: ubuntu-22.04
    if: github.event.inputs.cpp_standard == 'all' || github.event.inputs.cpp_standard == '11' || github.event.inputs.compiler == 'all' || github.event.inputs.compiler == 'clang'
    env:
      BUILD_DIR: build-cpp11
    strategy:
      matrix:
        cpp_standard: [11]
        compiler: [clang]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            binutils-gold \
            libssl-dev \
            libelf-dev \
            pkg-config \
            libboost-filesystem-dev \
            libboost-system-dev

      - name: Install LLVM 18
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y llvm-18-dev lld-18 clang-18

      - name: Set up LLVM Environment
        run: |
          echo "LLVM_CONFIG=/usr/bin/llvm-config-18" >> $GITHUB_ENV
          echo "LLVM_VERSION=18" >> $GITHUB_ENV
          echo "CC=clang-18" >> $GITHUB_ENV
          echo "CXX=clang++-18" >> $GITHUB_ENV

      - name: Build C++11 with Clang
        run: |
          ./scripts/build.sh --standard 11 --compiler clang --clean --tests

      - name: Run Unit Tests
        run: |
          cd $BUILD_DIR
          ctest --output-on-failure --verbose

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-cpp11-clang
          path: $BUILD_DIR/Testing/
          retention-days: 7

  # C++23 Build and Test
  cpp23-gcc:
    name: C++23 GCC Build & Test
    runs-on: ubuntu-22.04
    if: github.event.inputs.cpp_standard == 'all' || github.event.inputs.cpp_standard == '23' || github.event.inputs.compiler == 'all' || github.event.inputs.compiler == 'gcc'
    env:
      BUILD_DIR: build-cpp23
    strategy:
      matrix:
        cpp_standard: [23]
        compiler: [gcc]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            binutils-gold \
            libssl-dev \
            libelf-dev \
            pkg-config \
            libboost-filesystem-dev \
            libboost-system-dev

      - name: Install GCC 13 (for C++23 support)
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y gcc-13 g++-13

      - name: Install LLVM 20
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          sudo apt-get install -y llvm-20-dev lld-20

      - name: Set up Environment
        run: |
          echo "LLVM_CONFIG=/usr/bin/llvm-config-20" >> $GITHUB_ENV
          echo "LLVM_VERSION=20" >> $GITHUB_ENV
          echo "CC=gcc-13" >> $GITHUB_ENV
          echo "CXX=g++-13" >> $GITHUB_ENV

      - name: Build C++23 with GCC
        run: |
          ./scripts/build.sh --standard 23 --compiler gcc --clean --tests

      - name: Run Unit Tests
        run: |
          cd $BUILD_DIR
          ctest --output-on-failure --verbose

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-cpp23-gcc
          path: $BUILD_DIR/Testing/
          retention-days: 7

  cpp23-clang:
    name: C++23 Clang Build & Test
    runs-on: ubuntu-22.04
    if: github.event.inputs.cpp_standard == 'all' || github.event.inputs.cpp_standard == '23' || github.event.inputs.compiler == 'all' || github.event.inputs.compiler == 'clang'
    env:
      BUILD_DIR: build-cpp23
    strategy:
      matrix:
        cpp_standard: [23]
        compiler: [clang]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            binutils-gold \
            libssl-dev \
            libelf-dev \
            pkg-config \
            libboost-filesystem-dev \
            libboost-system-dev

      - name: Install LLVM 20
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          sudo apt-get install -y llvm-20-dev lld-20 clang-20

      - name: Set up Environment
        run: |
          echo "LLVM_CONFIG=/usr/bin/llvm-config-20" >> $GITHUB_ENV
          echo "LLVM_VERSION=20" >> $GITHUB_ENV
          echo "CC=clang-20" >> $GITHUB_ENV
          echo "CXX=clang++-20" >> $GITHUB_ENV

      - name: Build C++23 with Clang
        run: |
          ./scripts/build.sh --standard 23 --compiler clang --clean --tests

      - name: Run Unit Tests
        run: |
          cd $BUILD_DIR
          ctest --output-on-failure --verbose

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-cpp23-clang
          path: $BUILD_DIR/Testing/
          retention-days: 7

  # Coverage Analysis (C++17 as representative)
  coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      BUILD_DIR: build-cpp17
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            binutils-gold \
            libssl-dev \
            libelf-dev \
            pkg-config \
            libboost-filesystem-dev \
            libboost-system-dev \
            lcov \
            gcovr

      - name: Install LLVM 18
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y llvm-18-dev lld-18

      - name: Set up Environment
        run: |
          echo "LLVM_CONFIG=/usr/bin/llvm-config-18" >> $GITHUB_ENV
          echo "LLVM_VERSION=18" >> $GITHUB_ENV
          echo "CC=gcc" >> $GITHUB_ENV
          echo "CXX=g++" >> $GITHUB_ENV

      - name: Run Coverage Analysis
        run: |
          ./tests/coverage.sh

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage/coverage.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Build Examples
  examples:
    name: Build Examples
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      BUILD_DIR: build-cpp17
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            binutils-gold \
            libssl-dev \
            libelf-dev \
            pkg-config \
            libboost-filesystem-dev \
            libboost-system-dev

      - name: Install LLVM 18
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y llvm-18-dev lld-18

      - name: Set up Environment
        run: |
          echo "LLVM_CONFIG=/usr/bin/llvm-config-18" >> $GITHUB_ENV
          echo "LLVM_VERSION=18" >> $GITHUB_ENV
          echo "CC=gcc" >> $GITHUB_ENV
          echo "CXX=g++" >> $GITHUB_ENV

      - name: Build Main Project
        run: |
          ./scripts/build.sh --standard 17 --compiler gcc --clean

      - name: Build Examples
        run: |
          ./scripts/build.sh --standard 17 --compiler gcc --examples

      - name: Upload Example Builds
        uses: actions/upload-artifact@v4
        with:
          name: example-builds
          path: examples/*/build/
          retention-days: 7

  # Summary Job
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [cpp11-gcc, cpp11-clang, cpp23-gcc, cpp23-clang]
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build Status Summary
        run: |
          echo "## Build and Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.cpp11-gcc.result }}" == "success" ]; then
            echo "| C++11 GCC | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| C++11 GCC | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.cpp11-clang.result }}" == "success" ]; then
            echo "| C++11 Clang | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| C++11 Clang | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.cpp23-gcc.result }}" == "success" ]; then
            echo "| C++23 GCC | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| C++23 GCC | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.cpp23-clang.result }}" == "success" ]; then
            echo "| C++23 Clang | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| C++23 Clang | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage and Examples:**" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.coverage.result }}" == "success" ]; then
            echo "- Code Coverage: ✅ Generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Code Coverage: ❌ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.examples.result }}" == "success" ]; then
            echo "- Examples: ✅ Built" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Examples: ❌ Failed" >> $GITHUB_STEP_SUMMARY
          fi 